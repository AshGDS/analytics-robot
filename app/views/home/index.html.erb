<%= form_with url: fake_path, method: :post do |form| %>
  <%= form.label :environment %>
  <%= form.select :environment, @environments, { selected: params[:environment] }, {} %>

  <% if @runs.present? %>
    <%= form.label :runs %>
    <% @runs.each_with_index do |run, index| %>
      <%= fields_for "runs[]", index do |job| %>
        <%= render partial: 'run', locals: { interaction_types: @interaction_types, run: run, job: job, index: index } %>
      <% end %>
    <% end %>
  <% end %>

  <%= form.submit "Process" %>
  <button id="reset">Clear</button>
<% end %>

<p>Output</p>
<%= turbo_frame_tag id="faker-output" do %>
<% end %>

<%= select_tag :add_interaction_type, options_for_select(@interaction_types) %>
<%= number_field_tag :add_iterations, 1 %>
<button type="button" id="add-run">Add</button>

<script>
  window.onload = function (event) {
    var reset = document.getElementById("reset");
    reset.addEventListener("click", handleReset);

    var removeButtons = document.getElementsByClassName("remove-run");
    for (var i = 0; i < removeButtons.length; i++) {
      removeButtons[i].addEventListener("click", handleRemove);
    }

    var addRun = document.getElementById("add-run");
    addRun.addEventListener("click", handleAddRun);
  }

  function handleReset(event) {
    event.preventDefault();
    var output = document.getElementById("faker-output");
    output.innerHTML = "";
  }

  function handleRemove(event) {
    event.preventDefault();
    var index = event.target.id.split("-")[1];
    var runId = "run-" + index;
    var interactionType = document.getElementById("runs_" + index + "_interaction_type");
    var interaction = interactionType.options[interactionType.selectedIndex].text;
    var iterations = document.getElementById("runs_" + index + "_iterations").value;
    var run = document.getElementById(runId);
    var currentUrl = document.location;
    var newUrl = currentUrl.toString().replace("&runs[]=" + interaction + ":" + iterations, "");

    run.parentNode.removeChild(run);
    history.replaceState({}, "", newUrl);
    window.location.reload();
  }

  function handleAddRun(event) {
    event.preventDefault();
    var interactionType = document.getElementById("add_interaction_type");
    var interaction = interactionType.options[interactionType.selectedIndex].text;
    var iterations = document.getElementById("add_iterations").value;
    var newUrl = new URL(document.location + "&runs[]=" + interaction + ":" + iterations);

    history.replaceState({}, "", newUrl);
    window.location.reload();
  }
</script>
